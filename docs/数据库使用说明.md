# 充电桩charge数据库介绍及使用说明

## 数据库概述

- **数据库名称**: charge
- **MySQL版本**: 8.0+均可
- **字符集**: utf8mb4
- **存储引擎**: InnoDB

## 核心功能

### 1. 数据表结构

#### 1.1 充电桩实时数据表 (charging_realtime)
- **用途**: 存储每台充电桩设备的最新采集数据
- **关键字段**: 设备编号、状态、电压、电流、功率、温度、采集时间
- **索引**: 设备编号、采集时间、状态、设备编号及状态等复合索引

#### 1.2 充电桩历史数据表 (charging_history)
- **用途**: 存储每小时/每日的历史采集记录
- **关键字段**: 设备编号、平均电压、平均电流、平均功率、累计充电量
- **索引**: 设备编号+记录时间唯一索引

#### 1.3 充电桩告警记录表 (charging_alarm)
- **用途**: 记录充电桩运行中的各种告警事件
- **关键字段**: 设备编号、告警类型、告警值、阈值、处理状态
- **索引**: 设备编号+告警类型、状态、告警时间

#### 1.4 充电桩控制指令记录表 (charging_control)
- **用途**: 存储远程下发的控制指令及执行结果
- **关键字段**: 设备编号、控制指令、操作人、执行状态、执行时间
- **索引**: 设备编号+执行状态、操作人、执行时间

#### 1.5 运维用户表 (charging_user)
- **用途**: 管理系统人员、操作员等用户权限信息
- **关键字段**: 用户名、密码、角色、手机号、用户状态
- **索引**: 用户名唯一索引、角色、状态

#### 1.6 系统操作日志表 (charging_log)
- **用途**: 记录系统关键操作、异常告警、数据变更等
- **关键字段**: 操作用户、操作模块、执行动作、操作结果、日志时间
- **索引**: 用户、模块、日志时间、IP地址
- **分区**: 按月分区，便于数据管理和查询优化

### 2. 视图 (Views)

#### 2.1 充电桩实时状态视图 (v_charging_realtime_status)
- **用途**: 提供格式化的实时状态查询
- **特点**: 状态值转换为中文描述，数值格式化显示

#### 2.2 告警统计视图 (v_charging_alarm)
- **用途**: 按设备和告警类型统计告警次数和处理状态
- **特点**: 自动计算未处理、处理中、已处理数量

#### 2.3 设备使用率统计视图 (v_device_usage_rate)
- **用途**: 计算设备24小时内的使用率
- **特点**: 自动计算使用率百分比

### 3. 存储过程 (Stored Procedures)

#### 3.1 数据采集存储过程 (sp_collect_charging_data)
- **用途**: 安全地插入实时采集数据
- **特点**: 事务保护、自动日志记录

#### 3.2 告警处理存储过程 (sp_handle_alarm)
- **用途**: 处理告警状态更新
- **特点**: 事务保护、操作日志记录

#### 3.3 历史数据归档存储过程 (sp_archive_history_data)
- **用途**: 将7天前的实时数据归档到历史表
- **特点**: 自动数据归档、清理过期数据

### 4. 函数 (Functions)

#### 4.1 计算设备使用率函数 (fn_calculate_usage_rate)
- **用途**: 计算指定设备在指定时间内的使用率
- **参数**: 设备编号、时间范围(小时)
- **返回**: 使用率百分比

#### 4.2 检查设备状态函数 (fn_check_device_status)
- **用途**: 获取设备最新状态的中文描述
- **参数**: 设备编号
- **返回**: 状态中文描述

### 5. 触发器 (Triggers)

#### 5.1 实时数据更新触发器 (tr_charging_realtime_after_insert)
- **用途**: 在插入实时数据时自动检查告警条件
- **特点**: 自动触发过压、过流、过温告警

#### 5.2 控制指令执行触发器 (tr_charging_control_after_update)
- **用途**: 在更新控制指令状态时记录操作日志
- **特点**: 自动记录执行结果

### 6. 事件调度器 (Events)

#### 6.1 历史数据归档事件 (ev_archive_history_data)
- **执行时间**: 每天凌晨3点
- **用途**: 自动归档历史数据

#### 6.2 日志清理事件 (ev_cleanup_old_30days_logs)
- **执行时间**: 每天凌晨3点
- **用途**: 清理30天前的日志数据

## 数据库用户权限(不重要)

### 1. 应用用户 (charge_app)
- **权限**: SELECT, INSERT, UPDATE, DELETE
- **用途**: 应用程序连接使用
- **密码**: app123

### 2. 只读用户 (charge_read)
- **权限**: SELECT
- **用途**: 报表查询、数据分析
- **密码**: read123

### 3. 管理员用户 (charge_admin)
- **权限**: ALL PRIVILEGES
- **用途**: 数据库管理维护
- **密码**: admin123

## 性能优化特性

### 1. 索引优化
- **主键索引**: 所有表都有自增主键
- **唯一索引**: 用户名、设备编号+时间等关键字段
- **复合索引**: 查询频繁的字段组合
- **单列索引**: 状态、时间等常用查询字段

### 2. 分区表
- **charging_log表**: 按月分区，便于数据管理和查询优化
- **自动分区**: 包含未来的分区规划

### 3. 约束检查
- **数据完整性**: 所有关键字段都有CHECK约束
- **状态值验证**: 枚举值约束确保数据有效性
- **数值范围**: 电压、电流、功率、温度等数值范围限制

## 部分使用示例

### 1. 查询设备实时状态
```sql
SELECT * FROM v_charging_realtime_status WHERE 设备编号 = 'CP001';
```

### 2. 计算设备使用率
```sql
SELECT fn_calculate_usage_rate('CP001', 24) AS 使用率;
```

### 3. 处理告警
```sql
CALL sp_handle_alarm(1, 'admin', '已现场检查，设备正常');
```

### 4. 采集数据
```sql
CALL sp_collect_charging_data('CP001', 1, 220.5, 15.2, 3350.0, 28.7, NOW());
```


